[English Version](./README.md) | [Русская версия](./README.ru.md)

# S3 Prometheus Exporter

Этот проект представляет собой экспортер для Prometheus, который собирает и отображает метрики из бакета S3 (с использованием Rclone). Экспортер настроен для работы в Docker-контейнере с поддержкой HTTPS и Basic Auth для безопасности. Метрики периодически обновляются и предоставляются для сбора Prometheus.

В моем случае я использовал для отслеживания бэкапов Selectel в Grafana.

## Особенности
- Собирает метрики из бакета S3, включая названия файлов и метки времени их последнего изменения.
- Поддержка HTTPS с SSL-сертификатами.
- Использует Basic Auth для безопасного доступа.
- Настраиваемый интервал обновления и другие параметры через переменные окружения.

## Предварительные требования

- Docker
- Docker Compose
- Prometheus (для сбора метрик)
- Настроенный Rclone для доступа к S3 (с файлом `rclone.conf`)

## Настройка и использование

### 1. Клонирование репозитория

```bash
git clone https://github.com/yourusername/s3-prometheus-exporter.git
cd s3-prometheus-exporter
```

### 2. Настройка переменных окружения
Скопируйте файл .env.example в .env:

```bash
mv .env.example .env
```

Отредактируйте файл .env, чтобы задать название вашего S3-бакета, конфигурацию Rclone и другие необходимые параметры:

```bash
# Название вашего S3 бакета
BUCKET_NAME=your-s3-bucket-name

# Название конфигурации Rclone
RCLONE_REMOTE=your-rclone-config

# Интервал обновления метрик (в секундах)
INTERVAL=60

# Порт для работы HTTPS сервера
PORT=9337

# Учетные данные для Basic Auth
BASIC_AUTH_USER=your-user
BASIC_AUTH_PASS=your-password

# Пути к файлам SSL сертификата и ключа для HTTPS
SSL_CERT_FILE=/app/certs/server.crt
SSL_KEY_FILE=/app/certs/server.key
```

### 3. Добавление конфигурации Rclone

Убедитесь, что ваш файл rclone.conf правильно настроен для доступа к S3.

### 4. Генерация SSL-сертификатов или использование своих

Для работы этого проекта требуются SSL-сертификаты для защиты соединения. Вы можете либо сгенерировать самоподписанные сертификаты для разработки, либо использовать свои сертификаты, если они уже есть от доверенного центра сертификации (CA).

#### 4.1. Генерация самоподписанных SSL-сертификатов (для разработки)

Если у вас нет собственных SSL-сертификатов, вы можете сгенерировать самоподписанные сертификаты для тестирования с помощью следующей команды:

```bash
mkdir -p certs
openssl req -x509 -newkey rsa:4096 -keyout certs/server.key -out certs/server.crt -days 365 -nodes -subj "/CN=localhost"
```

Эта команда создаст два файла:

server.crt (сертификат)
server.key (приватный ключ)

Эти файлы будут сохранены в директории certs/ и использованы экспортером.

#### 4.2. Использование своих SSL-сертификатов

Если у вас уже есть действующие SSL-сертификаты от доверенного центра сертификации (CA), просто поместите файлы сертификата и ключа в директорию certs/ и обновите пути в файле .env:
```bash
SSL_CERT_FILE=/app/certs/your-certificate.crt
SSL_KEY_FILE=/app/certs/your-private.key
```

Теперь экспортер будет использовать ваш SSL-сертификат для безопасного HTTPS-соединения.

### 5. Сборка и запуск Docker-контейнера
Используйте Docker Compose для сборки и запуска контейнера:
```bash
docker-compose up --build
```

### 6. Доступ к метрикам
Когда контейнер запущен, вы можете получить доступ к метрикам Prometheus по HTTPS на порту, который вы указали (по умолчанию: 9337):

```bash
https://your-server-ip:9337/metrics
```

Не забудьте указать учетные данные Basic Auth, которые вы задали в файле .env.

### 7. Добавление в Prometheus

Чтобы настроить сбор данных, добавьте следующую конфигурацию в файл prometheus.yml:

```bash
scrape_configs:
  - job_name: 's3_exporter'
    basic_auth:
      username: 'your-user'
      password: 'your-password'
    static_configs:
      - targets: ['your-server-ip:9337']
```

